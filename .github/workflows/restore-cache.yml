##
## Bitcoin Integration Tests
##

name: Restore Binary Caches

# Only run when:
#   - PRs are (re)opened against master branch

on:
  workflow_call:

env:
  SEGMENT_DOWNLOAD_TIMEOUT_MINS: 15

concurrency:
  group: stacks-bitcoin-cache-${{ github.ref }}
  # Only cancel in progress if this is for a PR
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  restore-cargo-cache:
    name: Restore Cargo Cache
    runs-on: ubuntu-latest
    steps:
      - name: Check Cargo Cache
        uses: actions/cache@v3
        id: check_cache
        with:
          lookup-only: true
          path: ~/.cargo
          key: ${{ github.event.repository.name }}-cargo
          # key: ${{ github.event.repository.name }}-${{ github.sha }}-cargo

      - name: Restore Cargo Cache
        id: restore_cache
        uses: actions/cache/restore@v3
        with:
          fail-on-cache-miss: true
          path: ~/.cargo
          key: ${{ github.event.repository.name }}-cargo
          # key: ${{ github.event.repository.name }}-${{ github.sha }}-cargo

  restore-bitcoin-cache:
    name: Restore Bitcoin Binary Cache
    runs-on: ubuntu-latest
    steps:
      - name: Check Bitcoin Binary Cache
        uses: actions/cache@v3
        id: check_cache
        with:
          lookup-only: true
          path: /tmp/bitcoin
          key: ${{ github.event.repository.name }}-bitcoin-binaries

      - name: Restore Bitcoin Binary Cache
        id: restore_cache
        uses: actions/cache/restore@v3
        with:
          fail-on-cache-miss: true
          path: /tmp/bitcoin
          key: ${{ github.event.repository.name }}-bitcoin-binaries

      - name: Link Bitcoin Binary
        id: bitcoin_binary
        run: |
          sudo ln -s /tmp/bitcoin/bin/bitcoind /bin/
          ls -al /bin/bitcoind

  restore-target-cache:
    name: Restore Target Cache
    runs-on: ubuntu-latest
    steps:
      - name: Check Target Cache
        uses: actions/cache@v3
        id: check_cache
        with:
          lookup-only: true
          path: ./target/debug
          key: ${{ github.event.repository.name }}-target-debug
          # key: ${{ github.event.repository.name }}-${{ github.sha }}-target-debug

      - name: Restore Target Cache
        id: restore_target_cache
        uses: actions/cache/restore@v3
        with:
          fail-on-cache-miss: true
          path: ./target/debug
          key: ${{ github.event.repository.name }}-target-debug
          # key: ${{ github.event.repository.name }}-${{ github.sha }}-target-debug
